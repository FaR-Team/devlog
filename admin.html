<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devlog Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tinymce@5.10.0/skins/ui/oxide/skin.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; }
        #editor { height: 500px; }
        .sidebar { height: 100vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Main Content Area -->
            <main class="col-md-9 col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Bloggern't</h1>
                </div>

                <form id="postForm">
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg" id="title" placeholder="Post Title" required>
                    </div>

                    <div class="mb-3">
                        <textarea id="editor"></textarea>
                    </div>

                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">Publish</button>
                        <button type="button" id="saveButton" class="btn btn-secondary">Save</button>
                        <button type="button" id="previewButton" class="btn btn-info">Preview</button>
                    </div>
                </form>
            </main>

            <!-- Right Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar order-first">
                <div class="position-sticky">
                    <h4 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Post Settings</span>
                    </h4>
                    <div class="mb-3">
                        <label for="date" class="form-label">Publish Date</label>
                        <input type="datetime-local" class="form-control" id="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="tags" class="form-label">Labels</label>
                        <input type="text" class="form-control" id="tags" placeholder="Enter labels, comma-separated">
                    </div>
                    <div class="mb-3">
                        <label for="permalink" class="form-label">Permalink</label>
                        <input type="text" class="form-control" id="permalink">
                    </div>
                    <div class="mb-3">
                        <label for="comments" class="form-label">Comments</label>
                        <select class="form-select" id="comments">
                            <option value="allow">Allow</option>
                            <option value="disallow">Disallow</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sharing" class="form-label">Sharing</label>
                        <select class="form-select" id="sharing">
                            <option value="allow">Allow</option>
                            <option value="disallow">Disallow</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tinymce@5.10.0/tinymce.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
    <script>
        tinymce.init({
            selector: '#editor',
            plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen insertdatetime media table paste code help wordcount',
            toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
            height: 500
        });

        const converter = new showdown.Converter();

        let autoSaveInterval;

        function autoSave() {
            const title = document.getElementById('title').value;
            const content = tinymce.get('editor').getContent();
            localStorage.setItem('autoSaveTitle', title);
            localStorage.setItem('autoSaveContent', content);
            console.log('Auto-saved');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTitle = localStorage.getItem('autoSaveTitle');
            const savedContent = localStorage.getItem('autoSaveContent');
            if (savedTitle) document.getElementById('title').value = savedTitle;
            if (savedContent) tinymce.get('editor').setContent(savedContent);

            autoSaveInterval = setInterval(autoSave, 60000); // Auto-save every minute
        });

        document.getElementById('previewButton').addEventListener('click', () => {
            const title = document.getElementById('title').value;
            const content = tinymce.get('editor').getContent();
            const date = document.getElementById('date').value;

            // Convert HTML to Markdown
            const markdownContent = converter.makeMarkdown(content);

            // Convert Markdown back to HTML for preview
            const htmlContent = converter.makeHtml(markdownContent);

            const previewContent = `
                <h1>${title}</h1>
                <p>Published on: ${new Date(date).toLocaleDateString()}</p>

                ${htmlContent}
            `;

            const previewWindow = window.open();
            previewWindow.document.write(previewContent);
            previewWindow.document.close();
        });

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('title').value;
            const date = document.getElementById('date').value;
            const tags = document.getElementById('tags').value.split(',').map(tag => tag.trim());
            const permalink = document.getElementById('permalink').value;
            const comments = document.getElementById('comments').value;
            const sharing = document.getElementById('sharing').value;


            const htmlContent = tinymce.get('editor').getContent();
            const markdownContent = converter.makeMarkdown(htmlContent)
                .replace(/\n\s*\n/g, '\n\n')  // Fix extra line breaks
                .replace(/\*\*(.*?)\*\*/g, '**$1**')  // Fix bold text
                .replace(/\*(.*?)\*/g, '*$1*')  // Fix italic text
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '[$1]($2)')  // Fix links
                .trim();  // Remove leading/trailing whitespace

            const fileName = `_posts/${date.split('T')[0]}-${permalink || title.toLowerCase().replace(/\s+/g, '-')}.md`;
            const fileContent = `---
layout: post
title: "${title}"
date: ${date}
tags: [${tags.join(', ')}]
comments: ${comments}
sharing: ${sharing}
---

${markdownContent}`;

            try {
                // Use a method to write directly to the file system
                await writeFile(fileName, fileContent);
                alert('Post published successfully!');
                localStorage.removeItem('autoSaveTitle');
                localStorage.removeItem('autoSaveContent');
            } catch (err) {
                console.error('Error creating file:', err);
                alert('Error publishing post. See console for details.');
            }
        });

        document.getElementById('saveButton').addEventListener('click', () => {
            autoSave();
            alert('Post saved as draft');
        });
    </script>
</body>
</html>
